name: CI/CD Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Optional version bump: major | minor | patchï¼ˆç•™ç©ºå‰‡è‡ªå‹•åµæ¸¬ï¼‰'
        required: false
        default: ''
  push: 
    branches: [ master ]   # è‹¥é è¨­åˆ†æ”¯æ˜¯ mainï¼Œæ”¹æˆ [ main ]

permissions:
  contents: write

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  # === Step 1ï¼šå¤šç‰ˆæœ¬æ¸¬è©¦çŸ©é™£ï¼ˆNode 18 / 20ï¼‰===
  Test:
    name: Lint & Test (matrix)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      - name: Lint (if present)
        run: npm run lint --if-present

      - name: Test (if present)
        run: npm test --if-present

  # === Buildï¼šè‡ªå‹•åµæ¸¬ç‰ˆæœ¬å‡ç´š + è¨ˆç®—æ¨™ç±¤ ===
  Build:
    name: Build
    needs: [Test]
    runs-on: ubuntu-latest
    outputs:
      version:      ${{ steps.meta.outputs.version }}
      staging_tag:  ${{ steps.meta.outputs.staging_tag }}
      prod_tag:     ${{ steps.meta.outputs.prod_tag }}
      dev_tag:      ${{ steps.meta.outputs.dev_tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        if: ${{ hashFiles('**/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # === ğŸ”¥ æ–°å¢ï¼šè‡ªå‹•åµæ¸¬ bump é¡å‹ ===
      - name: Detect bump type automatically
        id: detect
        shell: bash
        run: |
          MSG=$(git log -1 --pretty=%B | tr '[:upper:]' '[:lower:]')
          echo "æœ€è¿‘ä¸€æ¬¡ commit message: $MSG"
          if [[ "$MSG" == *"breaking change"* ]]; then
            TYPE="major"
          elif [[ "$MSG" == *"feat:"* ]]; then
            TYPE="minor"
          elif [[ "$MSG" == *"fix:"* ]]; then
            TYPE="patch"
          else
            TYPE=""
          fi
          echo "type=$TYPE" >> "$GITHUB_OUTPUT"
          echo "è‡ªå‹•åµæ¸¬çµæœï¼š${TYPE:-ç„¡è®Šæ›´}"
      # === è¨ˆç®—ç‰ˆæœ¬èˆ‡æ¨™ç±¤ ===
      - name: Compute Version & Tags (O-level)
        id: meta
        shell: bash
        run: |
          # å¾ package.json æŠ“ç›®å‰ç‰ˆæœ¬
          if [ -f package.json ]; then
            BASE_VERSION=$(node -p "require('./package.json').version || '1.0.0'")
          else
            BASE_VERSION="1.0.0"
          fi
          # è‹¥æœ‰æ‰‹å‹•è¼¸å…¥ bumpï¼Œè¦†è“‹è‡ªå‹•åµæ¸¬
          if [ -n "${{ github.event.inputs.bump }}" ]; then
            BUMP="${{ github.event.inputs.bump }}"
          else
            BUMP="${{ steps.detect.outputs.type }}"
          fi
          echo "æœ€çµ‚ä½¿ç”¨çš„ bump é¡å‹: ${BUMP:-ç„¡}"
          # æ ¹æ“š bump é¡å‹ä¿®æ”¹ç‰ˆæœ¬è™Ÿ
          if [ -n "$BUMP" ]; then
            IFS='.' read -r MA MI PA <<< "$(echo "$BASE_VERSION" | sed 's/-.*//')"
            case "$BUMP" in
              major) MA=$((MA+1)); MI=0; PA=0 ;;
              minor) MI=$((MI+1)); PA=0 ;;
              patch|*) PA=$((PA+1)) ;;
            esac
            BASE_VERSION="${MA}.${MI}.${PA}"
          fi
          RUN_NO="${GITHUB_RUN_NUMBER}"
          STAGING_TAG="staging-v${BASE_VERSION}-rc.${RUN_NO}"
          PROD_TAG="prod-v${BASE_VERSION}"
          DEV_TAG="dev-v${BASE_VERSION}-alpha.${RUN_NO}"
          echo "version=$BASE_VERSION"    >> "$GITHUB_OUTPUT"
          echo "staging_tag=$STAGING_TAG" >> "$GITHUB_OUTPUT"
          echo "prod_tag=$PROD_TAG"       >> "$GITHUB_OUTPUT"
          echo "dev_tag=$DEV_TAG"         >> "$GITHUB_OUTPUT"
      # === é¡¯ç¤ºè¼¸å‡ºçµæœ ===
      - name: Show computed version & tags
        run: |
          echo "version=${{ steps.meta.outputs.version }}"
          echo "staging_tag=${{ steps.meta.outputs.staging_tag }}"
          echo "prod_tag=${{ steps.meta.outputs.prod_tag }}"
          echo "dev_tag=${{ steps.meta.outputs.dev_tag }}"
          {
            echo "## Build metadata"
            echo ""
            echo "- version: \`${{ steps.meta.outputs.version }}\`"
            echo "- staging_tag: \`${{ steps.meta.outputs.staging_tag }}\`"
            echo "- prod_tag: \`${{ steps.meta.outputs.prod_tag }}\`"
            echo "- dev_tag: \`${{ steps.meta.outputs.dev_tag }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Install deps & build
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          set -e
          npm ci || npm install
          npm run build --if-present || true
      - name: Archive workspace
        run: zip -r build.zip . -x ".git/*" "node_modules/*"

      - uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: build.zip
          retention-days: 7
  AutomatedTest:
    name: Run Automated Tests
    runs-on: ubuntu-latest
    needs: [Build]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      # âœ¨ æ–°å¢é€™æ®µè§£å£“ç¸®
      - name: Unzip build artifact
        run: unzip build-artifact.zip -d .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies for test
        run: npm install  # æ”¹æˆé€™æ¨£ï¼Œä¸è¦ç”¨ npm ci

      - name: Run Automated Tests
        run: |
          echo "ğŸ§ª é–‹å§‹åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦..."
          npm test || (echo "âŒ æ¸¬è©¦å¤±æ•—ï¼Œåœæ­¢å¾ŒçºŒéƒ¨ç½²ã€‚" && exit 1)
  # === éƒ¨ç½²åˆ° Dev ===
  DeployDev:
    name: Deploy to Dev
    needs: [AutomatedTest]
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/master' }}
    environment:
      name: dev   # âœ… æ”¹æˆå°å¯«ä»¥ç¬¦åˆå¯¦éš› environment åç¨±
      url: ${{ format('https://github.com/{0}/releases', github.repository) }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Release Dev Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ needs.Build.outputs.dev_tag }}
        run: |
          set -e
          echo "ğŸ”§ Releasing Dev build: $TAG"
          gh auth status || gh auth login --with-token <<< "$GH_TOKEN"
          gh release create "$TAG" build.zip --prerelease --generate-notes --repo "$REPO"

      # === æˆåŠŸé€šçŸ¥ Slack ===
      - name: Notify Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          VERSION: ${{ needs.Build.outputs.version }}
          TAG: ${{ needs.Build.outputs.dev_tag }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          MESSAGE="âœ… *Dev Build Successful!*%0Aâ€¢ Version: \`${VERSION}\`%0Aâ€¢ Tag: \`${TAG}\`%0Aâ€¢ Repository: https://github.com/${REPO}/releases/tag/${TAG}"
          echo "Sending Slack notification..."
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\"}" \
            "$SLACK_WEBHOOK_URL" || echo "âš ï¸ Slack notification failed (check webhook)"

      # === å¤±æ•—é€šçŸ¥ Slack ===
      - name: Notify Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          VERSION: ${{ needs.Build.outputs.version }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -e
          MESSAGE="âŒ *Dev Build Failed!*%0Aâ€¢ Version: \`${VERSION}\`%0Aâ€¢ Check logs: https://github.com/${REPO}/actions/runs/${RUN_ID}"
          echo "Sending Slack failure notification..."
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\"}" \
            "$SLACK_WEBHOOK_URL" || echo "âš ï¸ Slack notification failed (check webhook)"
  # === éƒ¨ç½²åˆ° Staging ===
  DeployStaging:
    name: Deploy to Staging
    needs: [AutomatedTest]
    runs-on: ubuntu-latest
    environment:
      name: Staging
      url: ${{ format('https://github.com/{0}/releases', github.repository) }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Release Staging Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ needs.Build.outputs.staging_tag }}
        run: |
          set -e
          gh auth status || gh auth login --with-token <<< "$GH_TOKEN"
          gh release create "$TAG" build.zip --prerelease --generate-notes --repo "$REPO"
      # === æˆåŠŸé€šçŸ¥ Slack ===
      - name: Notify Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          VERSION: ${{ needs.Build.outputs.version }}
          TAG: ${{ needs.Build.outputs.prod_tag }}
        run: |
          MESSAGE="âœ… *Staging Release Successful!*  
          â€¢ Version: \`${VERSION}\`  
          â€¢ Tag: \`${TAG}\`  
          â€¢ Repository: https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\"}" \
            "$SLACK_WEBHOOK_URL"

      # === å¤±æ•—é€šçŸ¥ Slack ===
      - name: Notify Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          VERSION: ${{ needs.Build.outputs.version }}
        run: |
          MESSAGE="âŒ *Staging Release Failed!*  
          â€¢ Version: \`${VERSION}\`  
          â€¢ Check logs: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\"}" \
            "$SLACK_WEBHOOK_URL"
  DeployProd:
    name: Deploy to Production
    needs: [DeployStaging, AutomatedTest]   # âœ… åŒæ™‚ä¾è³´ Build
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/master' }}
    environment:
      name: Production
      url: ${{ format('https://github.com/{0}/releases', github.repository) }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Print tag being released (Prod)
        run: echo "TAG=${{ needs.Build.outputs.prod_tag }}"

      - name: Release Production Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ needs.Build.outputs.prod_tag }}
        run: |
          set -e
          echo "Releasing $TAG ..."
          if [ -z "$TAG" ]; then
            echo "âŒ TAG æœªå®šç¾©ï¼Œè«‹æª¢æŸ¥ Build job æ˜¯å¦æˆåŠŸç”¢å‡º tag"
            exit 1
          fi
          gh auth status || gh auth login --with-token <<< "$GH_TOKEN"

          # === è‹¥ release å·²å­˜åœ¨ï¼Œå‰‡å…ˆåˆªé™¤èˆŠçš„ ===
          if gh release view "$TAG" --repo "$REPO" &>/dev/null; then
            echo "âš ï¸ Release $TAG å·²å­˜åœ¨ï¼Œå°‡å…ˆåˆªé™¤èˆŠçš„ release èˆ‡ tag..."
            gh release delete "$TAG" --repo "$REPO" --yes || true
            git push origin ":refs/tags/$TAG" || true
          fi

          # === é‡æ–°å»ºç«‹ release ===
          echo "ğŸš€ å»ºç«‹æ–°çš„ Release: $TAG"
          gh release create "$TAG" build.zip --generate-notes --repo "$REPO"
      # === æˆåŠŸé€šçŸ¥ Slack ===
      - name: Notify Slack (success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          VERSION: ${{ needs.Build.outputs.version }}
          TAG: ${{ needs.Build.outputs.prod_tag }}
        run: |
          MESSAGE="âœ… *Production Release Successful!*  
          â€¢ Version: \`${VERSION}\`  
          â€¢ Tag: \`${TAG}\`  
          â€¢ Repository: https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\"}" \
            "$SLACK_WEBHOOK_URL"

      # === å¤±æ•—é€šçŸ¥ Slack ===
      - name: Notify Slack (failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          VERSION: ${{ needs.Build.outputs.version }}
        run: |
          MESSAGE="âŒ *Production Release Failed!*  
          â€¢ Version: \`${VERSION}\`  
          â€¢ Check logs: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\"}" \
            "$SLACK_WEBHOOK_URL"
